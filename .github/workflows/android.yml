name: Android

on: [push]

jobs: 
  test:
    name: Test Android
    runs-on: ubuntu-latest
    container: termux/termux-docker:${{ matrix.arch }}
    strategy:
      matrix:
        arch: [i686, x86_64]
    steps:
    - run: /entrypoint.sh pkg install -y git openssh python-pip
      env:
          HOME: /data/data/com.termux/files/home
    - run: |
        echo "${{ secrets.SSH_KEY }}" > /data/data/com.termux/files/home/.ssh/id_ed25519
        echo "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl" > /data/data/com.termux/files/home/.ssh/known_hosts
        chown -vR 1000:1000 /data/data/com.termux/files/home/.ssh
        chmod -v 600 /data/data/com.termux/files/home/.ssh/{id_ed25519,known_hosts}
    - run: |
        /entrypoint.sh git clone git@github.com:real-LiHua/bk "$HOME/bk"
        /entrypoint.sh python -m venv .
        export VIRTUAL_ENV="$HOME"
        export PATH="$HOME/bin:$PATH"
        /entrypoint.sh pip install git+https://github.com/real-LiHua/KeyboxChecker
        /entrypoint.sh keyboxchecker "$HOME/bk"
      env:
          HOME: /data/data/com.termux/files/home
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_ed25519"
